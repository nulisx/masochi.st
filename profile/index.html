<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - Glowi.es</title>
    <link rel="stylesheet" href="/static/css/profile.css">
    <link rel="stylesheet" href="/static/css/global.css">
    <link rel="icon" href="/static/cdn/favicon.ico">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #0a0a0f;
            color: #fff;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            padding: 40px 20px;
        }
        
        .notification-modal-overlay {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.25s ease;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
        }
        
        .notification-modal {
            background: linear-gradient(180deg, rgba(147, 51, 234, 0.15), rgba(147, 51, 234, 0.05));
            border: 1px solid rgba(147, 51, 234, 0.4);
            border-radius: 14px;
            padding: 20px 24px;
            width: 90%;
            max-width: 380px;
            box-shadow: 0 10px 40px rgba(147, 51, 234, 0.3), inset 0 1px 0 rgba(255,255,255,0.1);
            backdrop-filter: blur(12px);
        }
        
        .profile-container {
            max-width: 600px;
            width: 100%;
            text-align: center;
        }
        
        .profile-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #9333ea;
            margin-bottom: 20px;
        }
        
        .profile-name {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .profile-username {
            font-size: 16px;
            color: #a0a0b0;
            margin-bottom: 16px;
        }
        
        .profile-bio {
            font-size: 15px;
            color: #c0c0d0;
            line-height: 1.6;
            margin-bottom: 32px;
        }
        
        .connections-grid {
            display: flex;
            justify-content: center;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 32px;
        }
        
        .connection-icon {
            width: 44px;
            height: 44px;
            background: #1a1a24;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            cursor: pointer;
            border: 1px solid #2a2a3a;
        }
        
        .connection-icon:hover {
            background: #9333ea;
            border-color: #9333ea;
            transform: translateY(-2px);
        }
        
        .connection-icon img {
            width: 24px;
            height: 24px;
        }
        
        .links-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .link-item {
            background: #16161f;
            border: 1px solid #2a2a3a;
            border-radius: 12px;
            padding: 16px 20px;
            color: #fff;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .link-item:hover {
            background: #1e1e2a;
            border-color: #9333ea;
            transform: translateY(-2px);
        }
        
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 50vh;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #2a2a3a;
            border-top-color: #9333ea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .error-state {
            text-align: center;
            padding: 40px;
        }
        
        .error-state h2 {
            color: #ef4444;
            margin-bottom: 12px;
        }
    </style>
</head>
<body>
    <div class="profile-container" id="profileContainer">
        <div class="loading">
            <div class="spinner"></div>
            <p style="margin-top: 16px; color: #a0a0b0;">Loading profile...</p>
        </div>
    </div>
    
    <script>
        const username = window.location.pathname.replace('/@', '');
        
        async function loadProfile() {
            try {
                const response = await fetch(`/api/biolink/${username}`);
                
                if (!response.ok) {
                    throw new Error('Profile not found');
                }
                
                const data = await response.json();
                renderProfile(data);
            } catch (error) {
                document.getElementById('profileContainer').innerHTML = `
                    <div class="error-state">
                        <h2>Profile Not Found</h2>
                        <p style="color: #a0a0b0;">The user @${username} does not exist.</p>
                        <a href="/" style="color: #9333ea; margin-top: 20px; display: inline-block;">Go Home</a>
                    </div>
                `;
            }
        }
        
        function showNotificationModal(message) {
            const existingNotif = document.querySelector('.notification-modal-overlay');
            if (existingNotif) existingNotif.remove();
            
            const notifHTML = `
                <div class="notification-modal-overlay">
                    <div class="notification-modal">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                            <div style="display: flex; align-items: center; justify-content: center; width: 24px; height: 24px;">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: #22c55e;">
                                    <polyline points="20 6 9 17 4 12"></polyline>
                                </svg>
                            </div>
                            <span style="color: #fff; font-weight: 500;">${message}</span>
                        </div>
                        <button onclick="this.closest('.notification-modal-overlay').remove()" style="width: 100%; padding: 10px 12px; background: linear-gradient(135deg, #9333ea, #a855f7); border: none; border-radius: 8px; color: white; font-weight: 500; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 12px rgba(147, 51, 234, 0.3);">
                            OK
                        </button>
                    </div>
                </div>
            `;
            const notifEl = document.createElement('div');
            notifEl.innerHTML = notifHTML;
            document.body.appendChild(notifEl.firstElementChild);
            
            setTimeout(() => {
                const overlay = document.querySelector('.notification-modal-overlay');
                if (overlay) {
                    overlay.style.opacity = '1';
                    overlay.style.visibility = 'visible';
                }
            }, 10);
        }
        
        function handleDiscordClick(e, connUsername, connUrl) {
            e.preventDefault();
            const hasUsername = connUsername && connUsername.trim().length > 0;
            const hasUserId = connUrl && connUrl.includes('discord.com/users');
            
            // Extract user ID from URL if it exists
            let userId = '';
            if (hasUserId) {
                const match = connUrl.match(/https:\/\/discord\.com\/users\/(\d+)/);
                if (match) userId = match[1];
            }
            
            // If only username: copy to clipboard
            if (hasUsername && !userId) {
                navigator.clipboard.writeText(connUsername).then(() => {
                    showNotificationModal(`Copied "${connUsername}" to clipboard`);
                });
                return;
            }
            
            // If only user ID: open Discord profile directly
            if (userId && !hasUsername) {
                window.open(`https://discord.com/users/${userId}`, '_blank');
                return;
            }
            
            // If both: show menu with options
            if (hasUsername && userId) {
                const existingMenu = document.querySelector('.discord-profile-menu');
                if (existingMenu) existingMenu.remove();
                
                const menuHTML = `
                    <div class="discord-profile-menu" style="position: fixed; background: linear-gradient(135deg, rgba(147, 51, 234, 0.1), rgba(168, 85, 247, 0.05)); border: 1px solid rgba(147, 51, 234, 0.3); border-radius: 12px; padding: 8px; z-index: 10000; box-shadow: 0 4px 20px rgba(147, 51, 234, 0.4), inset 0 1px 0 rgba(255,255,255,0.1); backdrop-filter: blur(8px);">
                        <button onclick="(() => {
                            navigator.clipboard.writeText('${connUsername}').then(() => {
                                showNotificationModal('Copied username to clipboard');
                                document.querySelector('.discord-profile-menu').remove();
                            });
                        })()" style="display: flex; align-items: center; gap: 10px; width: 100%; padding: 10px 12px; background: none; border: none; color: #fff; text-align: left; cursor: pointer; font-size: 14px; border-radius: 6px; transition: all 0.2s; white-space: nowrap; text-shadow: 0 1px 2px rgba(0,0,0,0.3);">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
                                <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
                            </svg>
                            Copy Username
                        </button>
                        <button onclick="(() => {
                            window.open('https://discord.com/users/${userId}', '_blank');
                            document.querySelector('.discord-profile-menu').remove();
                        })()" style="display: flex; align-items: center; gap: 10px; width: 100%; padding: 10px 12px; background: none; border: none; color: #fff; text-align: left; cursor: pointer; font-size: 14px; border-radius: 6px; transition: all 0.2s; margin-top: 4px; white-space: nowrap; text-shadow: 0 1px 2px rgba(0,0,0,0.3);">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                                <polyline points="15 3 21 3 21 9"></polyline>
                                <line x1="10" y1="14" x2="21" y2="3"></line>
                            </svg>
                            Open Profile
                        </button>
                    </div>
                `;
                const menuEl = document.createElement('div');
                menuEl.innerHTML = menuHTML;
                const menu = menuEl.querySelector('.discord-profile-menu');
                document.body.appendChild(menu);
                
                // Position menu near click
                menu.style.top = (e.clientY || 100) + 'px';
                menu.style.left = (e.clientX || 100) + 'px';
                
                // Close menu on outside click
                setTimeout(() => {
                    document.addEventListener('click', (evt) => {
                        if (evt.target !== menu && !menu.contains(evt.target)) {
                            menu.remove();
                        }
                    }, { once: true });
                }, 0);
            }
        }
        
        function renderProfile(data) {
            const { user, profile, links, connections } = data;
            
            let connectionsHtml = '';
            if (connections && connections.length > 0) {
                connectionsHtml = '<div class="connections-grid">';
                connections.forEach(conn => {
                    const iconPath = `/static/cdn/${conn.platform.toLowerCase()}.png`;
                    const url = conn.url || conn.profile_url || '#';
                    const isDiscord = conn.platform.toLowerCase() === 'discord';
                    const hasUserId = conn.url && conn.url.includes('discord.com/users');
                    const hasUsername = conn.username;
                    
                    if (isDiscord && (hasUserId || hasUsername)) {
                        connectionsHtml += `
                            <a href="#" onclick="handleDiscordClick(event, '${conn.username || ''}', '${conn.url || ''}')" class="connection-icon" title="${conn.platform}" style="cursor: pointer;">
                                <img src="${iconPath}" alt="${conn.platform}" onerror="this.style.display='none'">
                            </a>
                        `;
                    } else {
                        connectionsHtml += `
                            <a href="${url}" target="_blank" rel="noopener" class="connection-icon" title="${conn.platform}">
                                <img src="${iconPath}" alt="${conn.platform}" onerror="this.style.display='none'">
                            </a>
                        `;
                    }
                });
                connectionsHtml += '</div>';
            }
            
            let linksHtml = '';
            if (links && links.length > 0) {
                linksHtml = '<div class="links-container">';
                links.forEach(link => {
                    linksHtml += `
                        <a href="${link.url}" target="_blank" rel="noopener" class="link-item">
                            ${link.title}
                        </a>
                    `;
                });
                linksHtml += '</div>';
            }
            
            document.getElementById('profileContainer').innerHTML = `
                <img src="${profile.avatar_url || '/static/cdn/avatar.png'}" alt="${user.display_name}" class="profile-avatar">
                <h1 class="profile-name">${user.display_name || user.username}</h1>
                <p class="profile-username">@${user.username}</p>
                ${profile.bio ? `<p class="profile-bio">${profile.bio}</p>` : ''}
                ${connectionsHtml}
                ${linksHtml}
            `;
            
            document.title = `${user.display_name || user.username} - Glowi.es`;
        }
        
        loadProfile();
    </script>
</body>
</html>
