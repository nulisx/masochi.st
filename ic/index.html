<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 499.8 499.8'%3E%3Cpath fill='%238b5cf6' d='M477.16,292.045c0,0-62.848-4.221-125.061,22.069c11.664-13.634,23.084-28.804,33.416-45.603c51.428-83.723,56.047-174.385,56.047-174.385s-78.774,45.1-130.221,128.822c-7.563,12.3-13.99,24.738-19.668,37.029c3.467-20.557,5.744-42.617,5.744-65.72C297.417,86.977,249.892,0,249.892,0s-47.506,86.977-47.506,194.259c0,23.102,2.279,45.163,5.742,65.713c-5.68-12.293-12.123-24.723-19.67-37.023C137.017,139.227,58.238,94.127,58.238,94.127s4.623,90.662,56.05,174.385c10.329,16.799,21.75,31.969,33.416,45.603C85.472,287.824,22.64,292.045,22.64,292.045s37.99,47.329,100.418,73.905c23.818,10.137,47.734,15.764,68.231,18.881c-9.681,0.716-19.997,2.132-30.503,4.71c-45.443,11.111-77.006,38.909-77.006,38.909s42.105,9.768,87.561-1.351c29.467-7.217,52.928-21.347,65.893-30.448l-10.852,86.821c-0.506,4.125,0.635,8.272,3.157,11.404c2.522,3.125,6.147,4.923,9.974,4.923h20.791c3.826,0,7.451-1.798,9.975-4.923c2.522-3.132,3.66-7.279,3.156-11.404l-10.852-86.814c12.967,9.103,36.426,23.225,65.875,30.441c45.457,11.118,87.561,1.351,87.561,1.351s-31.564-27.798-77.002-38.909c-10.512-2.578-20.828-3.994-30.508-4.71c20.504-3.117,44.42-8.744,68.238-18.881C439.173,339.374,477.16,292.045,477.16,292.045z'/%3E%3C/svg%3E">
   <title>Invite Code Management - Glowi.es</title>
   <link rel="stylesheet" href="/static/css/global.css">
   <style>
      * {
         margin: 0;
         padding: 0;
         box-sizing: border-box;
      }
      
      body {
         font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
         background: #09090b;
         color: #fff;
         min-height: 100vh;
      }
      
      .navbar {
         background: #0f0f0f;
         border-bottom: 1px solid #1c1c1c;
         padding: 1rem 2rem;
         display: flex;
         justify-content: space-between;
         align-items: center;
      }
      
      .logo {
         display: flex;
         align-items: center;
         gap: 0.5rem;
         font-size: 1.25rem;
         font-weight: bold;
         text-decoration: none;
         color: white;
      }
      
      .logo-icon {
         width: 32px;
         height: 32px;
         fill: #8b5cf6;
      }
      
      .nav-right {
         display: flex;
         align-items: center;
         gap: 1rem;
      }
      
      .back-btn {
         padding: 0.5rem 1rem;
         background: #27272a;
         color: white;
         text-decoration: none;
         border-radius: 6px;
         font-size: 0.875rem;
         transition: background 0.2s;
      }
      
      .back-btn:hover {
         background: #3f3f46;
      }
      
      .container {
         max-width: 1200px;
         margin: 0 auto;
         padding: 2rem;
      }
      
      .page-header {
         margin-bottom: 2rem;
      }
      
      .page-header h1 {
         font-size: 1.75rem;
         margin-bottom: 0.5rem;
      }
      
      .page-header p {
         color: #a1a1aa;
      }
      
      .loading-state {
         display: flex;
         align-items: center;
         justify-content: center;
         min-height: 200px;
         color: #a1a1aa;
      }
      
      .error-state {
         background: #ef4444;
         padding: 1.5rem;
         border-radius: 12px;
         text-align: center;
         margin-bottom: 2rem;
      }
      
      .grid-layout {
         display: grid;
         grid-template-columns: 1fr 1.5fr;
         gap: 2rem;
      }
      
      @media (max-width: 900px) {
         .grid-layout {
            grid-template-columns: 1fr;
         }
      }
      
      .card {
         background: #1c1c1c;
         border: 1px solid #27272a;
         border-radius: 12px;
         padding: 1.5rem;
      }
      
      .card-title {
         font-size: 1.125rem;
         font-weight: 600;
         margin-bottom: 1rem;
         display: flex;
         align-items: center;
         gap: 0.5rem;
      }
      
      .form-group {
         margin-bottom: 1rem;
      }
      
      .form-group label {
         display: block;
         color: #a1a1aa;
         font-size: 0.875rem;
         margin-bottom: 0.5rem;
      }
      
      .form-group input,
      .form-group select {
         width: 100%;
         padding: 0.75rem 1rem;
         background: #27272a;
         border: 1px solid #3f3f46;
         border-radius: 6px;
         color: white;
         font-size: 1rem;
      }
      
      .form-group input:focus,
      .form-group select:focus {
         outline: none;
         border-color: #8b5cf6;
      }
      
      .btn-group {
         display: flex;
         gap: 0.5rem;
         margin-top: 1rem;
      }
      
      .btn {
         flex: 1;
         padding: 0.75rem 1rem;
         border: none;
         border-radius: 6px;
         cursor: pointer;
         font-size: 0.875rem;
         font-weight: 500;
         transition: background 0.2s;
      }
      
      .btn-primary {
         background: #8b5cf6;
         color: white;
      }
      
      .btn-primary:hover {
         background: #7c3aed;
      }
      
      .btn-secondary {
         background: #27272a;
         color: white;
      }
      
      .btn-secondary:hover {
         background: #3f3f46;
      }
      
      .btn-danger {
         background: #ef4444;
         color: white;
      }
      
      .btn-danger:hover {
         background: #dc2626;
      }
      
      .result-message {
         margin-top: 1rem;
         padding: 1rem;
         border-radius: 6px;
      }
      
      .result-message.success {
         background: rgba(34, 197, 94, 0.2);
         border: 1px solid #22c55e;
      }
      
      .result-message.error {
         background: rgba(239, 68, 68, 0.2);
         border: 1px solid #ef4444;
      }
      
      .invite-table {
         width: 100%;
         border-collapse: collapse;
      }
      
      .invite-table th,
      .invite-table td {
         padding: 0.75rem;
         text-align: left;
         border-bottom: 1px solid #27272a;
      }
      
      .invite-table th {
         color: #a1a1aa;
         font-size: 0.75rem;
         text-transform: uppercase;
         letter-spacing: 0.05em;
      }
      
      .invite-table tr:hover {
         background: #27272a;
      }
      
      .status-badge {
         display: inline-block;
         padding: 0.25rem 0.5rem;
         border-radius: 4px;
         font-size: 0.75rem;
         font-weight: 500;
      }
      
      .status-active {
         background: rgba(34, 197, 94, 0.2);
         color: #22c55e;
      }
      
      .status-used {
         background: rgba(239, 68, 68, 0.2);
         color: #ef4444;
      }
      
      .status-expired {
         background: rgba(251, 191, 36, 0.2);
         color: #fbbf24;
      }
      
      .role-badge {
         display: inline-block;
         padding: 0.25rem 0.5rem;
         border-radius: 4px;
         font-size: 0.75rem;
         font-weight: 500;
         background: rgba(139, 92, 246, 0.2);
         color: #8b5cf6;
      }
      
      .action-btn {
         padding: 0.25rem 0.5rem;
         background: #ef4444;
         border: none;
         border-radius: 4px;
         color: white;
         cursor: pointer;
         font-size: 0.75rem;
      }
      
      .action-btn:hover {
         background: #dc2626;
      }
      
      .copy-btn {
         background: #27272a;
         padding: 0.25rem 0.5rem;
         border: none;
         border-radius: 4px;
         color: white;
         cursor: pointer;
         font-size: 0.75rem;
         margin-left: 0.5rem;
      }
      
      .copy-btn:hover {
         background: #3f3f46;
      }
      
      .empty-state {
         text-align: center;
         padding: 2rem;
         color: #a1a1aa;
      }
      
      .code-display {
         font-family: monospace;
         background: #27272a;
         padding: 0.25rem 0.5rem;
         border-radius: 4px;
      }
   </style>
</head>
<body>
   <div class="navbar">
      <a href="/dashboard" class="logo">
         <svg class="logo-icon" viewBox="0 0 499.8 499.8" xmlns="http://www.w3.org/2000/svg">
            <path d="M477.16,292.045c0,0-62.848-4.221-125.061,22.069c11.664-13.634,23.084-28.804,33.416-45.603c51.428-83.723,56.047-174.385,56.047-174.385s-78.774,45.1-130.221,128.822c-7.563,12.3-13.99,24.738-19.668,37.029c3.467-20.557,5.744-42.617,5.744-65.72C297.417,86.977,249.892,0,249.892,0s-47.506,86.977-47.506,194.259c0,23.102,2.279,45.163,5.742,65.713c-5.68-12.293-12.123-24.723-19.67-37.023C137.017,139.227,58.238,94.127,58.238,94.127s4.623,90.662,56.05,174.385c10.329,16.799,21.75,31.969,33.416,45.603C85.472,287.824,22.64,292.045,22.64,292.045s37.99,47.329,100.418,73.905c23.818,10.137,47.734,15.764,68.231,18.881c-9.681,0.716-19.997,2.132-30.503,4.71c-45.443,11.111-77.006,38.909-77.006,38.909s42.105,9.768,87.561-1.351c29.467-7.217,52.928-21.347,65.893-30.448l-10.852,86.821c-0.506,4.125,0.635,8.272,3.157,11.404c2.522,3.125,6.147,4.923,9.974,4.923h20.791c3.826,0,7.451-1.798,9.975-4.923c2.522-3.132,3.66-7.279,3.156-11.404l-10.852-86.814c12.967,9.103,36.426,23.225,65.875,30.441c45.457,11.118,87.561,1.351,87.561,1.351s-31.564-27.798-77.002-38.909c-10.512-2.578-20.828-3.994-30.508-4.71c20.504-3.117,44.42-8.744,68.238-18.881C439.173,339.374,477.16,292.045,477.16,292.045z"/>
         </svg>
         Glowi.es
      </a>
      <div class="nav-right">
         <a href="/dashboard" class="back-btn">Back to Dashboard</a>
      </div>
   </div>

   <div class="container">
      <div class="page-header">
         <h1>Invite Code Management</h1>
         <p>Create and manage invite codes for new users</p>
      </div>

      <div id="loading-state" class="loading-state">
         Loading...
      </div>

      <div id="error-state" class="error-state" style="display: none;">
         <h3>Access Denied</h3>
         <p id="error-message">You need admin privileges to access this page.</p>
         <a href="/login" class="btn btn-primary" style="margin-top: 1rem; display: inline-block;">Login</a>
      </div>

      <div id="main-content" style="display: none;">
         <div class="grid-layout">
            <div class="card">
               <div class="card-title">Create New Invite</div>
               <div class="form-group">
                  <label for="code-input">Invite Code</label>
                  <input type="text" id="code-input" placeholder="GLOWI-XXXXXXXX">
               </div>
               <div class="form-group">
                  <label for="role-select">Role</label>
                  <select id="role-select">
                     <option value="user">User</option>
                     <option value="mod">Moderator</option>
                     <option value="admin">Admin</option>
                  </select>
               </div>
               <div class="form-group">
                  <label for="max-uses">Max Uses</label>
                  <input type="number" id="max-uses" value="1" min="1">
               </div>
               <div class="btn-group">
                  <button id="random-btn" class="btn btn-secondary">Random</button>
                  <button id="generate-btn" class="btn btn-primary">Create Code</button>
               </div>
               <div id="result-area"></div>
            </div>

            <div class="card">
               <div class="card-title">All Invite Codes</div>
               <div id="invites-list">
                  <div class="loading-state">Loading invites...</div>
               </div>
            </div>
         </div>
      </div>
   </div>

   <script>
      let currentUser = null;

      function generateRandomCode() {
         const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
         let code = 'GLOWI-';
         for (let i = 0; i < 8; i++) {
            code += chars.charAt(Math.floor(Math.random() * chars.length));
         }
         return code;
      }

      async function checkAuth() {
         try {
            const response = await fetch('/api/auth/me', {
               credentials: 'include'
            });

            if (!response.ok) {
               showError('Please login to access this page.');
               return false;
            }

            const data = await response.json();
            currentUser = data.user;

            if (!['owner', 'admin', 'manager', 'mod'].includes(currentUser.role)) {
               showError('You need admin or moderator privileges to access this page.');
               return false;
            }

            return true;
         } catch (error) {
            console.error('Auth check failed:', error);
            showError('Authentication failed. Please login again.');
            return false;
         }
      }

      function showError(message) {
         document.getElementById('loading-state').style.display = 'none';
         document.getElementById('main-content').style.display = 'none';
         document.getElementById('error-state').style.display = 'block';
         document.getElementById('error-message').textContent = message;
      }

      function showContent() {
         document.getElementById('loading-state').style.display = 'none';
         document.getElementById('error-state').style.display = 'none';
         document.getElementById('main-content').style.display = 'block';
      }

      async function loadInvites() {
         const container = document.getElementById('invites-list');
         
         try {
            const response = await fetch('/api/invites', {
               credentials: 'include'
            });

            if (!response.ok) {
               throw new Error('Failed to load invites');
            }

            const data = await response.json();
            const invites = data.invites || [];

            if (invites.length === 0) {
               container.innerHTML = '<div class="empty-state">No invite codes yet. Create one above!</div>';
               return;
            }

            container.innerHTML = `
               <table class="invite-table">
                  <thead>
                     <tr>
                        <th>Code</th>
                        <th>Role</th>
                        <th>Uses</th>
                        <th>Status</th>
                        <th>Action</th>
                     </tr>
                  </thead>
                  <tbody>
                     ${invites.map(invite => {
                        const isUsed = invite.used || (invite.uses_count >= invite.max_uses);
                        const isExpired = invite.expires_at && new Date(invite.expires_at) < new Date();
                        let status = 'Active';
                        let statusClass = 'status-active';
                        
                        if (isUsed) {
                           status = 'Used';
                           statusClass = 'status-used';
                        } else if (isExpired) {
                           status = 'Expired';
                           statusClass = 'status-expired';
                        }
                        
                        return `
                           <tr>
                              <td>
                                 <span class="code-display">${invite.code}</span>
                                 <button class="copy-btn" onclick="copyCode('${invite.code}')">Copy</button>
                              </td>
                              <td><span class="role-badge">${invite.role || 'user'}</span></td>
                              <td>${invite.uses_count || 0}/${invite.max_uses || 1}</td>
                              <td><span class="status-badge ${statusClass}">${status}</span></td>
                              <td>
                                 <button class="action-btn" onclick="deleteInvite('${invite.code}')">Delete</button>
                              </td>
                           </tr>
                        `;
                     }).join('')}
                  </tbody>
               </table>
            `;
         } catch (error) {
            console.error('Error loading invites:', error);
            container.innerHTML = '<div class="error-state">Failed to load invites</div>';
         }
      }

      function copyCode(code) {
         navigator.clipboard.writeText(code).then(() => {
            alert('Copied: ' + code);
         }).catch(() => {
            alert('Failed to copy');
         });
      }

      async function deleteInvite(code) {
         if (!confirm('Are you sure you want to delete this invite code?')) return;

         try {
            const response = await fetch(`/api/invites/${code}`, {
               method: 'DELETE',
               credentials: 'include'
            });

            if (!response.ok) {
               const data = await response.json();
               throw new Error(data.error || 'Failed to delete invite');
            }

            loadInvites();
         } catch (error) {
            console.error('Delete error:', error);
            alert('Error: ' + error.message);
         }
      }

      document.getElementById('random-btn').addEventListener('click', function() {
         document.getElementById('code-input').value = generateRandomCode();
      });

      document.getElementById('generate-btn').addEventListener('click', async function() {
         const code = document.getElementById('code-input').value;
         const role = document.getElementById('role-select').value;
         const maxUses = parseInt(document.getElementById('max-uses').value);
         const resultArea = document.getElementById('result-area');

         if (!code) {
            resultArea.innerHTML = '<div class="result-message error">Please enter or generate an invite code</div>';
            return;
         }

         resultArea.innerHTML = '<div class="result-message">Creating invite code...</div>';

         try {
            const response = await fetch('/api/invites', {
               method: 'POST',
               headers: {
                  'Content-Type': 'application/json'
               },
               credentials: 'include',
               body: JSON.stringify({
                  code,
                  role,
                  max_uses: maxUses
               })
            });

            const data = await response.json();

            if (!response.ok) {
               throw new Error(data.error || 'Failed to create invite code');
            }

            resultArea.innerHTML = `
               <div class="result-message success">
                  Invite code created successfully!
               </div>
            `;

            document.getElementById('code-input').value = '';
            loadInvites();
         } catch (error) {
            console.error('Error:', error);
            resultArea.innerHTML = `
               <div class="result-message error">
                  Error: ${error.message}
               </div>
            `;
         }
      });

      async function init() {
         const isAuthed = await checkAuth();
         if (isAuthed) {
            showContent();
            loadInvites();
         }
      }

      init();
   </script>
</body>
</html>
