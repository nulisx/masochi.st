<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Advanced Keyboard Sounds Controller Overlay</title>
<style>
:root{
  --bg:#0a0e1a;
  --card:#0f1420;
  --accent:#7c3aed;
  --accent-light:#a855f7;
  --muted:#6b7280;
  --text:#e6eef8;
  --ok:#10b981;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0}
body{
  background:linear-gradient(135deg,#030511 0%,#0a0f1f 50%,#050a15 100%);
  color:var(--text);
  font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,sans-serif;
  display:flex;
  align-items:center;
  justify-content:center;
  min-height:100vh;
  padding:16px;
  -webkit-font-smoothing:antialiased;
}
.main{
  display:grid;
  grid-template-columns:1fr 700px;
  gap:32px;
  max-width:1600px;
  width:100%;
}
.panel{
  background:linear-gradient(135deg,rgba(124,58,237,0.08),rgba(168,85,247,0.04));
  border:1px solid rgba(168,85,247,0.15);
  padding:32px;
  border-radius:20px;
  box-shadow:0 20px 60px rgba(0,0,0,0.5);
  backdrop-filter:blur(10px);
}
.title{
  display:flex;
  gap:16px;
  margin-bottom:28px;
}
.logo{
  width:60px;
  height:60px;
  border-radius:14px;
  background:linear-gradient(135deg,#7c3aed,#a855f7);
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:800;
  font-size:24px;
  box-shadow:0 8px 24px rgba(124,58,237,0.4);
  flex-shrink:0;
}
.title-text h1{font-size:26px;font-weight:800;margin:0}
.title-text p{font-size:13px;color:var(--muted);margin:4px 0 0}
.controls{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(110px,1fr));
  gap:12px;
  margin-bottom:24px;
}
.btn{
  background:linear-gradient(135deg,rgba(168,85,247,0.2),rgba(124,58,237,0.1));
  border:1px solid rgba(168,85,247,0.4);
  padding:12px 16px;
  border-radius:10px;
  color:var(--text);
  font-weight:600;
  font-size:13px;
  cursor:pointer;
  transition:all 0.3s cubic-bezier(0.4,0,0.2,1);
}
.btn:hover{
  background:linear-gradient(135deg,rgba(168,85,247,0.3),rgba(124,58,237,0.2));
  border-color:rgba(168,85,247,0.7);
  transform:translateY(-2px);
}
.btn.active{
  background:linear-gradient(135deg,rgba(168,85,247,0.5),rgba(124,58,237,0.3));
  box-shadow:0 0 20px rgba(168,85,247,0.5);
}
.row{
  display:flex;
  gap:12px;
  align-items:center;
  margin-bottom:16px;
  flex-wrap:wrap;
}
.label{
  font-size:12px;
  color:var(--muted);
  font-weight:600;
  text-transform:uppercase;
  letter-spacing:0.5px;
}
.select,.range{
  background:linear-gradient(135deg,rgba(168,85,247,0.1),rgba(124,58,237,0.05));
  border:1px solid rgba(168,85,247,0.2);
  color:var(--text);
  border-radius:8px;
  font-size:13px;
  padding:10px 12px;
}
.select{cursor:pointer}
.range{
  appearance:none;
  width:100%;
  height:4px;
  padding:0;
}
.range::-webkit-slider-thumb{
  appearance:none;
  width:16px;
  height:16px;
  background:linear-gradient(135deg,#7c3aed,#a855f7);
  border-radius:50%;
  cursor:pointer;
  box-shadow:0 4px 12px rgba(124,58,237,0.4);
}
.status-box{
  background:rgba(16,185,129,0.1);
  border:1px solid rgba(16,185,129,0.3);
  padding:14px;
  border-radius:12px;
  display:flex;
  gap:12px;
  align-items:center;
  margin-bottom:20px;
}
.indicator{
  width:10px;
  height:10px;
  border-radius:50%;
  background:rgba(255,255,255,0.2);
  animation:pulse 2s ease-in-out infinite;
}
.indicator.connected{
  background:#10b981;
  box-shadow:0 0 12px rgba(16,185,129,0.8);
}
.info{
  font-size:12px;
  color:var(--muted);
}
.info-strong{
  color:var(--text);
  font-weight:600;
}
.info-box{
  background:rgba(99,102,241,0.08);
  border:1px dashed rgba(99,102,241,0.2);
  padding:12px;
  border-radius:10px;
  font-size:12px;
  color:var(--muted);
  line-height:1.6;
  margin-bottom:20px;
}
.keys-section{
  margin-bottom:20px;
}
.keys-label{
  font-size:11px;
  color:var(--muted);
  text-transform:uppercase;
  letter-spacing:0.5px;
  margin-bottom:8px;
  font-weight:600;
}
.keys-display{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
}
.key-chip{
  background:linear-gradient(135deg,rgba(168,85,247,0.25),rgba(124,58,237,0.15));
  border:1px solid rgba(168,85,247,0.4);
  padding:8px 12px;
  border-radius:8px;
  font-size:12px;
  font-weight:600;
  color:var(--accent-light);
  animation:slideIn 0.3s ease-out;
}
@keyframes slideIn{
  from{opacity:0;transform:translateX(-10px)}
  to{opacity:1;transform:translateX(0)}
}
.controller-panel{
  display:flex;
  flex-direction:column;
}
.controller-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:20px;
}
.controller-header h2{
  margin:0;
  font-size:18px;
  font-weight:700;
}
.controller-viz{
  background:linear-gradient(135deg,#0a0e1a,#050812);
  border:1px solid rgba(168,85,247,0.2);
  border-radius:16px;
  padding:24px;
  display:flex;
  align-items:center;
  justify-content:center;
  min-height:600px;
  margin-bottom:20px;
  position:relative;
  overflow:auto;
}
.controller-viz svg{
  max-width:100%;
  height:auto;
  filter:drop-shadow(0 20px 40px rgba(0,0,0,0.6));
}
.stats-grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:12px;
}
.stat-box{
  background:rgba(255,255,255,0.02);
  border:1px solid rgba(168,85,247,0.15);
  padding:12px;
  border-radius:10px;
}
.stat-label{
  font-size:11px;
  color:var(--muted);
  text-transform:uppercase;
  letter-spacing:0.5px;
  margin-bottom:4px;
}
.stat-value{
  font-size:13px;
  color:var(--accent-light);
  font-weight:700;
  font-family:monospace;
}
@media (max-width:1200px){
  .main{grid-template-columns:1fr}
  .controller-viz{min-height:500px}
}
</style>
</head>
<body>
<div class="main">
  <div class="panel">
    <div class="title">
      <div class="logo">KS</div>
      <div>
        <h1>Keyboard Sounds</h1>
        <p>Advanced controller & keyboard ASMR overlay</p>
      </div>
    </div>

    <div class="controls">
      <button id="startBtn" class="btn">â–¶ Start Audio</button>
      <button id="scanBtn" class="btn">â†» Scan</button>
      <select id="profile" class="select">
        <option value="mechanical">Mechanical</option>
        <option value="cherry">Cherry MX</option>
        <option value="typewriter">Typewriter</option>
        <option value="bubble">Bubble</option>
        <option value="linear">Linear</option>
      </select>
    </div>

    <div class="row">
      <label class="label">Volume</label>
      <input type="range" id="volume" class="range" min="0" max="1" step="0.01" value="0.7" style="flex:1;max-width:150px;"/>
      <span id="volDisplay" style="font-size:12px;color:var(--accent-light);min-width:35px;">70%</span>
    </div>

    <div class="status-box">
      <span class="indicator" id="gpIndicator"></span>
      <div>
        <div class="info"><span class="info-strong" id="gpName">No Controller</span></div>
        <div class="info" id="gpInfo" style="font-size:11px;margin-top:2px;"></div>
      </div>
    </div>

    <div class="info-box">
      ðŸŽ® Connect PS4, PS5, or Xbox controller via USB/Bluetooth. Press buttons or move analog sticks to trigger ASMR keyboard sounds. Each input triggers unique audio.
    </div>

    <div class="keys-section">
      <div class="keys-label">Keyboard Input</div>
      <div class="keys-display" id="recentKeys"></div>
    </div>

    <div class="keys-section">
      <div class="keys-label">Button Input</div>
      <div class="keys-display" id="recentButtons"></div>
    </div>

    <div class="keys-section">
      <div class="keys-label">Analog Input</div>
      <div class="keys-display" id="recentAnalog"></div>
    </div>
  </div>

  <div class="panel controller-panel">
    <div class="controller-header">
      <h2>Controller Overlay</h2>
      <label style="font-size:12px;color:var(--muted);display:flex;gap:8px;">
        <input type="checkbox" id="autoRepeat" checked/>
        Auto-repeat
      </label>
    </div>
    <div class="controller-viz" id="controllerViz"></div>
    <div class="stats-grid">
      <div class="stat-box">
        <div class="stat-label">L Stick</div>
        <div class="stat-value" id="lStick">x:0.00 y:0.00</div>
      </div>
      <div class="stat-box">
        <div class="stat-label">R Stick</div>
        <div class="stat-value" id="rStick">x:0.00 y:0.00</div>
      </div>
      <div class="stat-box">
        <div class="stat-label">Triggers</div>
        <div class="stat-value" id="triggers">L:0.00 R:0.00</div>
      </div>
      <div class="stat-box">
        <div class="stat-label">Profile</div>
        <div class="stat-value" id="profileName">Mechanical</div>
      </div>
    </div>
  </div>
</div>

<script>
let audioCtx=null,masterGain=null,isRunning=false,profile="mechanical";
let connectedGpIndex=null,prevButtonStates=[],prevAxes=[];
let lastPressTimes={},lastStickMovements={};
const MIN_INTERVAL=80,STICK_DEADZONE=0.2,STICK_MOVE_THRESHOLD=0.15;

const soundLibrary={
  mechanical:{freq:2200,q:1.8,dur:0.045},
  cherry:{freq:2600,q:1.5,dur:0.05},
  typewriter:{freq:3200,q:0.9,dur:0.055},
  bubble:{freq:1800,q:2.2,dur:0.04},
  linear:{freq:2000,q:1.4,dur:0.035}
};

const elements={
  startBtn:document.getElementById("startBtn"),
  scanBtn:document.getElementById("scanBtn"),
  profile:document.getElementById("profile"),
  volume:document.getElementById("volume"),
  volDisplay:document.getElementById("volDisplay"),
  gpIndicator:document.getElementById("gpIndicator"),
  gpName:document.getElementById("gpName"),
  gpInfo:document.getElementById("gpInfo"),
  recentKeys:document.getElementById("recentKeys"),
  recentButtons:document.getElementById("recentButtons"),
  recentAnalog:document.getElementById("recentAnalog"),
  controllerViz:document.getElementById("controllerViz"),
  lStick:document.getElementById("lStick"),
  rStick:document.getElementById("rStick"),
  triggers:document.getElementById("triggers"),
  profileName:document.getElementById("profileName"),
  autoRepeat:document.getElementById("autoRepeat")
};

function initAudio(){
  if(audioCtx)return;
  audioCtx=new(window.AudioContext||window.webkitAudioContext)();
  masterGain=audioCtx.createGain();
  masterGain.gain.value=Number(elements.volume.value);
  masterGain.connect(audioCtx.destination);
}

elements.startBtn.addEventListener("click",()=>{
  initAudio();
  if(audioCtx.state==="suspended")audioCtx.resume();
  isRunning=true;
  elements.startBtn.classList.add("active");
  elements.startBtn.textContent="â¸ Running";
});

elements.profile.addEventListener("change",(e)=>{
  profile=e.target.value;
  elements.profileName.textContent=profile.charAt(0).toUpperCase()+profile.slice(1);
});

elements.volume.addEventListener("input",(e)=>{
  const vol=Math.round(Number(e.target.value)*100);
  elements.volDisplay.textContent=vol+"%";
  if(masterGain)masterGain.gain.value=Number(e.target.value);
});

elements.scanBtn.addEventListener("click",()=>scanGamepads(true));

function playSound(kind=profile,velocity=1){
  if(!audioCtx)return;
  const now=audioCtx.currentTime;
  const config=soundLibrary[kind]||soundLibrary.mechanical;
  const noise=audioCtx.createBufferSource();
  const bufLen=Math.floor(audioCtx.sampleRate*config.dur);
  const buffer=audioCtx.createBuffer(1,bufLen,audioCtx.sampleRate);
  const data=buffer.getChannelData(0);
  for(let i=0;i<bufLen;i++){
    data[i]=(Math.random()*2-1)*Math.exp(-i/bufLen*7)*velocity*0.9;
  }
  noise.buffer=buffer;
  const filter=audioCtx.createBiquadFilter();
  filter.type="bandpass";
  filter.frequency.value=config.freq;
  filter.Q.value=config.q;
  const gain=audioCtx.createGain();
  gain.gain.value=0.75;
  noise.connect(filter);
  filter.connect(gain);
  gain.connect(masterGain);
  noise.start(now);
  noise.stop(now+config.dur);
}

window.addEventListener("keydown",(e)=>{
  if(!isRunning||["Shift","Control","Alt","Meta"].includes(e.key))return;
  addRecentKey(e.key);
  playSound(profile,1.0);
});

function addRecentKey(k){
  const chip=document.createElement("div");
  chip.className="key-chip";
  chip.textContent=k.length>1?k.substring(0,8):k;
  elements.recentKeys.prepend(chip);
  while(elements.recentKeys.children.length>10)elements.recentKeys.removeChild(elements.recentKeys.lastChild);
}

function addRecentButton(s){
  const chip=document.createElement("div");
  chip.className="key-chip";
  chip.textContent=s;
  elements.recentButtons.prepend(chip);
  while(elements.recentButtons.children.length>10)elements.recentButtons.removeChild(elements.recentButtons.lastChild);
}

function addRecentAnalog(s){
  const chip=document.createElement("div");
  chip.className="key-chip";
  chip.textContent=s;
  elements.recentAnalog.prepend(chip);
  while(elements.recentAnalog.children.length>10)elements.recentAnalog.removeChild(elements.recentAnalog.lastChild);
}

function detectControllerType(gamepad){
  const id=gamepad.id.toLowerCase();
  if(id.includes("ps5")||id.includes("dualsense"))return"PS5";
  if(id.includes("054c")||id.includes("ps4"))return"PS4";
  if(id.includes("xbox"))return"Xbox";
  return"PS4";
}

function renderPS4Controller(){
  const svg=`<svg viewBox="0 0 600 400" width="480" height="320">
    <defs>
      <radialGradient id="bodyGrad" cx="40%" cy="30%">
        <stop offset="0%" style="stop-color:#2a2a2a;stop-opacity:1" />
        <stop offset="100%" style="stop-color:#0a0a0a;stop-opacity:1" />
      </radialGradient>
      <filter id="shadow" x="-50%" y="-50%" width="200%" height="200%">
        <feDropShadow dx="2" dy="4" stdDeviation="3" flood-opacity="0.4"/>
      </filter>
    </defs>
    
    <g filter="url(#shadow)">
      <path d="M 100 80 Q 50 100 50 200 Q 50 320 150 350 L 450 350 Q 550 320 550 200 Q 550 100 500 80 Z" fill="url(#bodyGrad)" stroke="#1a1a1a" stroke-width="2"/>
      
      <ellipse cx="150" cy="120" rx="35" ry="45" fill="#1a1a1a" stroke="#333" stroke-width="1"/>
      <ellipse cx="150" cy="125" rx="32" ry="42" fill="#252525"/>
      
      <ellipse cx="450" cy="120" rx="35" ry="45" fill="#1a1a1a" stroke="#333" stroke-width="1"/>
      <ellipse cx="450" cy="125" rx="32" ry="42" fill="#252525"/>
      
      <g id="dpad">
        <path d="M 180 180 L 220 180 L 220 220 L 180 220 Z" fill="#333" stroke="#1a1a1a" stroke-width="1"/>
        <path d="M 190 185 L 210 185 L 210 215 L 190 215 Z" fill="#1a1a1a"/>
        <rect x="195" y="190" width="10" height="40" fill="#444" stroke="#222" stroke-width="0.5"/>
        <rect x="180" y="200" width="40" height="10" fill="#444" stroke="#222" stroke-width="0.5"/>
      </g>
      
      <g id="buttons">
        <circle cx="390" cy="160" r="16" fill="#2a4a8a" stroke="#1a2a6a" stroke-width="1"/>
        <circle cx="390" cy="160" r="13" fill="#3a5aaa"/>
        <text x="390" y="168" text-anchor="middle" fill="#e6eef8" font-size="16" font-weight="bold">â–³</text>
        
        <circle cx="420" cy="190" r="16" fill="#3a6a4a" stroke="#1a4a2a" stroke-width="1"/>
        <circle cx="420" cy="190" r="13" fill="#4a7a5a"/>
        <text x="420" y="198" text-anchor="middle" fill="#e6eef8" font-size="16" font-weight="bold">â—¯</text>
        
        <circle cx="360" cy="190" r="16" fill="#8a3a4a" stroke="#6a1a2a" stroke-width="1"/>
        <circle cx="360" cy="190" r="13" fill="#aa4a5a"/>
        <text x="360" y="198" text-anchor="middle" fill="#e6eef8" font-size="16" font-weight="bold">âœ•</text>
        
        <circle cx="390" cy="220" r="16" fill="#5a4a3a" stroke="#3a2a1a" stroke-width="1"/>
        <circle cx="390" cy="220" r="13" fill="#6a5a4a"/>
        <text x="390" y="228" text-anchor="middle" fill="#e6eef8" font-size="16" font-weight="bold">â–¢</text>
      </g>
      
      <g id="l-triggers">
        <rect x="120" y="50" width="50" height="30" rx="8" fill="#1a1a1a" stroke="#333" stroke-width="1"/>
        <rect x="125" y="55" width="40" height="20" rx="6" fill="#2a2a2a"/>
        <text x="145" y="72" text-anchor="middle" fill="#999" font-size="11">L2</text>
        
        <rect x="140" y="20" width="40" height="25" rx="6" fill="#1a1a1a" stroke="#333" stroke-width="1"/>
        <rect x="145" y="25" width="30" height="15" rx="4" fill="#2a2a2a"/>
        <text x="160" y="37" text-anchor="middle" fill="#999" font-size="10">L1</text>
      </g>
      
      <g id="r-triggers">
        <rect x="430" y="50" width="50" height="30" rx="8" fill="#1a1a1a" stroke="#333" stroke-width="1"/>
        <rect x="435" y="55" width="40" height="20" rx="6" fill="#2a2a2a"/>
        <text x="455" y="72" text-anchor="middle" fill="#999" font-size="11">R2</text>
        
        <rect x="420" y="20" width="40" height="25" rx="6" fill="#1a1a1a" stroke="#333" stroke-width="1"/>
        <rect x="425" y="25" width="30" height="15" rx="4" fill="#2a2a2a"/>
        <text x="440" y="37" text-anchor="middle" fill="#999" font-size="10">R1</text>
      </g>
      
      <g id="center">
        <rect x="235" y="155" width="45" height="20" rx="4" fill="#1a1a1a" stroke="#333" stroke-width="1"/>
        <text x="257.5" y="169" text-anchor="middle" fill="#666" font-size="9">SHARE</text>
        
        <rect x="320" y="155" width="45" height="20" rx="4" fill="#1a1a1a" stroke="#333" stroke-width="1"/>
        <text x="342.5" y="169" text-anchor="middle" fill="#666" font-size="9">OPT</text>
        
        <circle cx="300" cy="200" r="20" fill="#0a0a0a" stroke="#333" stroke-width="2"/>
        <circle cx="300" cy="200" r="16" fill="#1a1a1a"/>
        <text x="300" y="207" text-anchor="middle" fill="#666" font-size="20">âš«</text>
      </g>
      
      <g id="sticks">
        <circle cx="140" cy="280" r="22" fill="#2a2a2a" stroke="#444" stroke-width="2"/>
        <circle cx="140" cy="280" r="18" fill="#3a3a3a"/>
        <circle cx="140" cy="280" r="14" fill="#4a4a4a"/>
        <text x="140" y="285" text-anchor="middle" fill="#777" font-size="10">L</text>
        
        <circle cx="460" cy="280" r="22" fill="#2a2a2a" stroke="#444" stroke-width="2"/>
        <circle cx="460" cy="280" r="18" fill="#3a3a3a"/>
        <circle cx="460" cy="280" r="14" fill="#4a4a4a"/>
        <text x="460" y="285" text-anchor="middle" fill="#777" font-size="10">R</text>
      </g>
    </g>
  </svg>`;
  elements.controllerViz.innerHTML=svg;
}

function renderPS5Controller(){
  const svg=`<svg viewBox="0 0 600 450" width="480" height="360">
    <defs>
      <radialGradient id="ps5Grad" cx="40%" cy="30%">
        <stop offset="0%" style="stop-color:#3a3a3a;stop-opacity:1" />
        <stop offset="100%" style="stop-color:#0a0a0a;stop-opacity:1" />
      </radialGradient>
    </defs>
    
    <g>
      <path d="M 100 100 Q 40 130 40 230 Q 40 380 180 400 L 420 400 Q 560 380 560 230 Q 560 130 500 100 Z" fill="url(#ps5Grad)" stroke="#222" stroke-width="2"/>
      
      <ellipse cx="160" cy="150" rx="40" ry="55" fill="#1a1a1a"/>
      <ellipse cx="160" cy="150" rx="35" ry="50" fill="#2a2a2a"/>
      
      <ellipse cx="440" cy="150" rx="40" ry="55" fill="#1a1a1a"/>
      <ellipse cx="440" cy="150" rx="35" ry="50" fill="#2a2a2a"/>
      
      <g id="ps5-dpad">
        <path d="M 190 200 L 230 200 L 230 240 L 190 240 Z" fill="#1a1a1a"/>
        <rect x="200" y="205" width="8" height="30" fill="#444"/>
        <rect x="192" y="215" width="36" height="8" fill="#444"/>
      </g>
      
      <g id="ps5-buttons">
        <circle cx="395" cy="160" r="18" fill="#2a5aaa"/>
        <text x="395" y="170" text-anchor="middle" fill="#fff" font-size="18" font-weight="bold">â–³</text>
        
        <circle cx="435" cy="200" r="18" fill="#3a6a4a"/>
        <text x="435" y="210" text-anchor="middle" fill="#fff" font-size="18" font-weight="bold">â—¯</text>
        
        <circle cx="355" cy="200" r="18" fill="#8a3a4a"/>
        <text x="355" y="210" text-anchor="middle" fill="#fff" font-size="18" font-weight="bold">âœ•</text>
        
        <circle cx="395" cy="240" r="18" fill="#6a5a4a"/>
        <text x="395" y="250" text-anchor="middle" fill="#fff" font-size="18" font-weight="bold">â–¢</text>
      </g>
      
      <g id="ps5-triggers">
        <rect x="110" y="60" width="60" height="35" rx="10" fill="#1a1a1a"/>
        <rect x="118" y="68" width="44" height="22" rx="8" fill="#2a2a2a"/>
        <text x="140" y="87" text-anchor="middle" fill="#888" font-size="12">L2</text>
        
        <rect x="135" y="20" width="50" height="30" rx="8" fill="#1a1a1a"/>
        <rect x="142" y="28" width="36" height="18" rx="6" fill="#2a2a2a"/>
        <text x="160" y="42" text-anchor="middle" fill="#888" font-size="10">L1</text>
      </g>
      
      <g id="ps5-triggers2">
        <rect x="430" y="60" width="60" height="35" rx="10" fill="#1a1a1a"/>
        <rect x="438" y="68" width="44" height="22" rx="8" fill="#2a2a2a"/>
        <text x="460" y="87" text-anchor="middle" fill="#888" font-size="12">R2</text>
        
        <rect x="415" y="20" width="50" height="30" rx="8" fill="#1a1a1a"/>
        <rect x="422" y="28" width="36" height="18" rx="6" fill="#2a2a2a"/>
        <text x="440" y="42" text-anchor="middle" fill="#888" font-size="10">R1</text>
      </g>
      
      <rect x="245" y="190" width="50" height="25" rx="5" fill="#1a1a1a"/>
      <text x="270" y="210" text-anchor="middle" fill="#555" font-size="10">SHARE</text>
      
      <rect x="305" y="190" width="50" height="25" rx="5" fill="#1a1a1a"/>
      <text x="330" y="210" text-anchor="middle" fill="#555" font-size="10">CREATE</text>
      
      <circle cx="300" cy="270" r="26" fill="#1a1a1a"/>
      <circle cx="300" cy="270" r="22" fill="#2a2a2a"/>
      <text x="300" y="278" text-anchor="middle" fill="#666" font-size="24">âš«</text>
      
      <circle cx="150" cy="330" r="26" fill="#2a2a2a"/>
      <circle cx="150" cy="330" r="20" fill="#3a3a3a"/>
      <text x="150" y="337" text-anchor="middle" fill="#666" font-size="12">L</text>
      
      <circle cx="450" cy="330" r="26" fill="#2a2a2a"/>
      <circle cx="450" cy="330" r="20" fill="#3a3a3a"/>
      <text x="450" y="337" text-anchor="middle" fill="#666" font-size="12">R</text>
    </g>
  </svg>`;
  elements.controllerViz.innerHTML=svg;
}

function scanGamepads(force=false){
  const gps=navigator.getGamepads?navigator.getGamepads():[];
  let found=false;
  for(let i=0;i<gps.length;i++){
    const g=gps[i];
    if(g&&g.connected){
      found=true;
      connectedGpIndex=i;
      prevButtonStates=new Array(g.buttons.length).fill(false);
      prevAxes=new Array(g.axes.length).fill(0);
      const type=detectControllerType(g);
      elements.gpIndicator.classList.add("connected");
      elements.gpName.textContent=type+" Connected";
      elements.gpInfo.textContent=g.id.substring(0,50);
      if(type==="PS5")renderPS5Controller();
      else renderPS4Controller();
      break;
    }
  }
  if(!found){
    elements.gpIndicator.classList.remove("connected");
    elements.gpName.textContent="No Controller";
    elements.gpInfo.textContent="";
    renderPS4Controller();
    connectedGpIndex=null;
  }
}

function pollGamepad(){
  const gps=navigator.getGamepads?navigator.getGamepads():[];
  const g=connectedGpIndex!==null?gps[connectedGpIndex]:null;
  if(!g){
    for(let i=0;i<gps.length;i++){
      if(gps[i]&&gps[i].connected){
        connectedGpIndex=i;
        scanGamepads(true);
        break;
      }
    }
    requestAnimationFrame(pollGamepad);
    return;
  }
  const buttons=g.buttons;
  for(let i=0;i<buttons.length;i++){
    const pressed=buttons[i].pressed||buttons[i].value>0.1;
    const prev=prevButtonStates[i]||false;
    if(pressed&&(!prev||elements.autoRepeat.checked)){
      handleButtonPress(i,buttons[i].value);
    }
    prevButtonStates[i]=pressed;
  }
  const axes=g.axes;
  if(axes.length>=4){
    const lx=Math.abs(axes[0])>STICK_DEADZONE?axes[0]:0;
    const ly=Math.abs(axes[1])>STICK_DEADZONE?axes[1]:0;
    const rx=Math.abs(axes[2])>STICK_DEADZONE?axes[2]:0;
    const ry=Math.abs(axes[3])>STICK_DEADZONE?axes[3]:0;
    elements.lStick.textContent=`x:${lx.toFixed(2)} y:${ly.toFixed(2)}`;
    elements.rStick.textContent=`x:${rx.toFixed(2)} y:${ry.toFixed(2)}`;
    if((Math.abs(lx)>STICK_MOVE_THRESHOLD||Math.abs(ly)>STICK_MOVE_THRESHOLD)&&isRunning){
      const now=performance.now();
      if(!lastStickMovements.l||now-lastStickMovements.l>150){
        lastStickMovements.l=now;
        addRecentAnalog("LS");
        playSound(profile,0.6);
      }
    }
    if((Math.abs(rx)>STICK_MOVE_THRESHOLD||Math.abs(ry)>STICK_MOVE_THRESHOLD)&&isRunning){
      const now=performance.now();
      if(!lastStickMovements.r||now-lastStickMovements.r>150){
        lastStickMovements.r=now;
        addRecentAnalog("RS");
        playSound(profile,0.6);
      }
    }
  }
  const l2=buttons[6]?buttons[6].value:0;
  const r2=buttons[7]?buttons[7].value:0;
  elements.triggers.textContent=`L:${l2.toFixed(2)} R:${r2.toFixed(2)}`;
  if((l2>0.1||r2>0.1)&&isRunning){
    const now=performance.now();
    if(!lastStickMovements.t||now-lastStickMovements.t>200){
      lastStickMovements.t=now;
      addRecentAnalog(l2>r2?"L2":"R2");
      playSound(profile,0.7);
    }
  }
  requestAnimationFrame(pollGamepad);
}

function handleButtonPress(index,value){
  const now=performance.now();
  const key="b"+index;
  if(lastPressTimes[key]&&(now-lastPressTimes[key]<MIN_INTERVAL))return;
  lastPressTimes[key]=now;
  if(!isRunning)return;
  const readable=["âœ•","â—¯","â–¢","â–³","L1","R1","L2","R2","Share","Create","L3","R3","â†‘","â†“","â†","â†’","PS","Touch"][index]||"Btn";
  addRecentButton(readable);
  const velocity=Math.min(1,Math.max(0.2,value||1));
  playSound(profile,velocity);
}

window.addEventListener("gamepadconnected",()=>scanGamepads(true));
window.addEventListener("gamepaddisconnected",()=>scanGamepads(true));
document.body.addEventListener("pointerdown",()=>{initAudio();if(audioCtx&&audioCtx.state==="suspended")audioCtx.resume()},{once:true});

scanGamepads();
pollGamepad();
</script>
</body>
</html>
