<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Advanced Keyboard Sounds Controller Overlay</title>
<style>
:root{
  --bg:#0a0e1a;
  --card:#0f1420;
  --accent:#7c3aed;
  --accent-light:#a855f7;
  --muted:#6b7280;
  --text:#e6eef8;
  --ok:#10b981;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0}
body{
  background:linear-gradient(135deg,#030511 0%,#0a0f1f 50%,#050a15 100%);
  color:var(--text);
  font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,sans-serif;
  display:flex;
  align-items:center;
  justify-content:center;
  min-height:100vh;
  padding:16px;
  -webkit-font-smoothing:antialiased;
}
.main{
  display:grid;
  grid-template-columns:1fr 600px;
  gap:32px;
  max-width:1600px;
  width:100%;
}
.panel{
  background:linear-gradient(135deg,rgba(124,58,237,0.08),rgba(168,85,247,0.04));
  border:1px solid rgba(168,85,247,0.15);
  padding:32px;
  border-radius:20px;
  box-shadow:0 20px 60px rgba(0,0,0,0.5);
  backdrop-filter:blur(10px);
}
.title{
  display:flex;
  gap:16px;
  margin-bottom:28px;
}
.logo{
  width:60px;
  height:60px;
  border-radius:14px;
  background:linear-gradient(135deg,#7c3aed,#a855f7);
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:800;
  font-size:24px;
  box-shadow:0 8px 24px rgba(124,58,237,0.4);
  flex-shrink:0;
}
.title-text h1{font-size:26px;font-weight:800;margin:0}
.title-text p{font-size:13px;color:var(--muted);margin:4px 0 0}
.controls{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(110px,1fr));
  gap:12px;
  margin-bottom:24px;
}
.btn{
  background:linear-gradient(135deg,rgba(168,85,247,0.2),rgba(124,58,237,0.1));
  border:1px solid rgba(168,85,247,0.4);
  padding:12px 16px;
  border-radius:10px;
  color:var(--text);
  font-weight:600;
  font-size:13px;
  cursor:pointer;
  transition:all 0.3s cubic-bezier(0.4,0,0.2,1);
}
.btn:hover{
  background:linear-gradient(135deg,rgba(168,85,247,0.3),rgba(124,58,237,0.2));
  border-color:rgba(168,85,247,0.7);
  transform:translateY(-2px);
}
.btn.active{
  background:linear-gradient(135deg,rgba(168,85,247,0.5),rgba(124,58,237,0.3));
  box-shadow:0 0 20px rgba(168,85,247,0.5);
}
.row{
  display:flex;
  gap:12px;
  align-items:center;
  margin-bottom:16px;
  flex-wrap:wrap;
}
.label{
  font-size:12px;
  color:var(--muted);
  font-weight:600;
  text-transform:uppercase;
  letter-spacing:0.5px;
}
.select,.range{
  background:linear-gradient(135deg,rgba(168,85,247,0.1),rgba(124,58,237,0.05));
  border:1px solid rgba(168,85,247,0.2);
  color:var(--text);
  border-radius:8px;
  font-size:13px;
  padding:10px 12px;
}
.select{cursor:pointer}
.range{
  appearance:none;
  width:100%;
  height:4px;
  padding:0;
}
.range::-webkit-slider-thumb{
  appearance:none;
  width:16px;
  height:16px;
  background:linear-gradient(135deg,#7c3aed,#a855f7);
  border-radius:50%;
  cursor:pointer;
  box-shadow:0 4px 12px rgba(124,58,237,0.4);
}
.status-box{
  background:rgba(16,185,129,0.1);
  border:1px solid rgba(16,185,129,0.3);
  padding:14px;
  border-radius:12px;
  display:flex;
  gap:12px;
  align-items:center;
  margin-bottom:20px;
}
.indicator{
  width:10px;
  height:10px;
  border-radius:50%;
  background:rgba(255,255,255,0.2);
  animation:pulse 2s ease-in-out infinite;
}
.indicator.connected{
  background:#10b981;
  box-shadow:0 0 12px rgba(16,185,129,0.8);
}
.info{
  font-size:12px;
  color:var(--muted);
}
.info-strong{
  color:var(--text);
  font-weight:600;
}
.info-box{
  background:rgba(99,102,241,0.08);
  border:1px dashed rgba(99,102,241,0.2);
  padding:12px;
  border-radius:10px;
  font-size:12px;
  color:var(--muted);
  line-height:1.6;
  margin-bottom:20px;
}
.keys-section{
  margin-bottom:20px;
}
.keys-label{
  font-size:11px;
  color:var(--muted);
  text-transform:uppercase;
  letter-spacing:0.5px;
  margin-bottom:8px;
  font-weight:600;
}
.keys-display{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
}
.key-chip{
  background:linear-gradient(135deg,rgba(168,85,247,0.25),rgba(124,58,237,0.15));
  border:1px solid rgba(168,85,247,0.4);
  padding:8px 12px;
  border-radius:8px;
  font-size:12px;
  font-weight:600;
  color:var(--accent-light);
  animation:slideIn 0.3s ease-out;
}
@keyframes slideIn{
  from{opacity:0;transform:translateX(-10px)}
  to{opacity:1;transform:translateX(0)}
}
.controller-panel{
  display:flex;
  flex-direction:column;
}
.controller-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:20px;
}
.controller-header h2{
  margin:0;
  font-size:18px;
  font-weight:700;
}
.controller-viz{
  background:linear-gradient(135deg,#0a0e1a,#050812);
  border:1px solid rgba(168,85,247,0.2);
  border-radius:16px;
  padding:24px;
  display:flex;
  align-items:center;
  justify-content:center;
  min-height:500px;
  margin-bottom:20px;
  position:relative;
  overflow:hidden;
}
.controller-viz svg{
  max-width:100%;
  height:auto;
}
.stats-grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:12px;
}
.stat-box{
  background:rgba(255,255,255,0.02);
  border:1px solid rgba(168,85,247,0.15);
  padding:12px;
  border-radius:10px;
}
.stat-label{
  font-size:11px;
  color:var(--muted);
  text-transform:uppercase;
  letter-spacing:0.5px;
  margin-bottom:4px;
}
.stat-value{
  font-size:13px;
  color:var(--accent-light);
  font-weight:700;
  font-family:monospace;
}
@media (max-width:1200px){
  .main{grid-template-columns:1fr}
  .controller-viz{min-height:400px}
}
</style>
</head>
<body>
<div class="main">
  <div class="panel">
    <div class="title">
      <div class="logo">KS</div>
      <div>
        <h1>Keyboard Sounds</h1>
        <p>Advanced controller & keyboard ASMR overlay</p>
      </div>
    </div>

    <div class="controls">
      <button id="startBtn" class="btn">â–¶ Start Audio</button>
      <button id="scanBtn" class="btn">â†» Scan</button>
      <select id="profile" class="select">
        <option value="mechanical">Mechanical</option>
        <option value="cherry">Cherry MX</option>
        <option value="typewriter">Typewriter</option>
        <option value="bubble">Bubble</option>
        <option value="linear">Linear</option>
      </select>
    </div>

    <div class="row">
      <label class="label">Volume</label>
      <input type="range" id="volume" class="range" min="0" max="1" step="0.01" value="0.7" style="flex:1;max-width:150px;"/>
      <span id="volDisplay" style="font-size:12px;color:var(--accent-light);min-width:35px;">70%</span>
    </div>

    <div class="status-box">
      <span class="indicator" id="gpIndicator"></span>
      <div>
        <div class="info"><span class="info-strong" id="gpName">No Controller</span></div>
        <div class="info" id="gpInfo" style="font-size:11px;margin-top:2px;"></div>
      </div>
    </div>

    <div class="info-box">
      ðŸŽ® Connect PS4, PS5, or Xbox controller via USB/Bluetooth. Press buttons or move analog sticks to trigger ASMR keyboard sounds. Each input type has unique audio characteristics.
    </div>

    <div class="keys-section">
      <div class="keys-label">Keyboard Input</div>
      <div class="keys-display" id="recentKeys"></div>
    </div>

    <div class="keys-section">
      <div class="keys-label">Button Input</div>
      <div class="keys-display" id="recentButtons"></div>
    </div>

    <div class="keys-section">
      <div class="keys-label">Analog Input</div>
      <div class="keys-display" id="recentAnalog"></div>
    </div>
  </div>

  <div class="panel controller-panel">
    <div class="controller-header">
      <h2>Controller Overlay</h2>
      <label style="font-size:12px;color:var(--muted);display:flex;gap:8px;">
        <input type="checkbox" id="autoRepeat" checked/>
        Auto-repeat
      </label>
    </div>
    <div class="controller-viz" id="controllerViz"></div>
    <div class="stats-grid">
      <div class="stat-box">
        <div class="stat-label">L Stick</div>
        <div class="stat-value" id="lStick">x:0.00 y:0.00</div>
      </div>
      <div class="stat-box">
        <div class="stat-label">R Stick</div>
        <div class="stat-value" id="rStick">x:0.00 y:0.00</div>
      </div>
      <div class="stat-box">
        <div class="stat-label">Triggers</div>
        <div class="stat-value" id="triggers">L:0.00 R:0.00</div>
      </div>
      <div class="stat-box">
        <div class="stat-label">Profile</div>
        <div class="stat-value" id="profileName">Mechanical</div>
      </div>
    </div>
  </div>
</div>

<script>
let audioCtx=null,masterGain=null,isRunning=false,profile="mechanical";
let connectedGpIndex=null,prevButtonStates=[],prevAxes=[];
let lastPressTimes={},lastStickMovements={};
const MIN_INTERVAL=80,STICK_DEADZONE=0.2,STICK_MOVE_THRESHOLD=0.15;

const soundLibrary={
  mechanical:{freq:2200,q:1.8,dur:0.045},
  cherry:{freq:2600,q:1.5,dur:0.05},
  typewriter:{freq:3200,q:0.9,dur:0.055},
  bubble:{freq:1800,q:2.2,dur:0.04},
  linear:{freq:2000,q:1.4,dur:0.035}
};

const elements={
  startBtn:document.getElementById("startBtn"),
  scanBtn:document.getElementById("scanBtn"),
  profile:document.getElementById("profile"),
  volume:document.getElementById("volume"),
  volDisplay:document.getElementById("volDisplay"),
  gpIndicator:document.getElementById("gpIndicator"),
  gpName:document.getElementById("gpName"),
  gpInfo:document.getElementById("gpInfo"),
  recentKeys:document.getElementById("recentKeys"),
  recentButtons:document.getElementById("recentButtons"),
  recentAnalog:document.getElementById("recentAnalog"),
  controllerViz:document.getElementById("controllerViz"),
  lStick:document.getElementById("lStick"),
  rStick:document.getElementById("rStick"),
  triggers:document.getElementById("triggers"),
  profileName:document.getElementById("profileName"),
  autoRepeat:document.getElementById("autoRepeat")
};

function initAudio(){
  if(audioCtx)return;
  audioCtx=new(window.AudioContext||window.webkitAudioContext)();
  masterGain=audioCtx.createGain();
  masterGain.gain.value=Number(elements.volume.value);
  masterGain.connect(audioCtx.destination);
}

elements.startBtn.addEventListener("click",()=>{
  initAudio();
  if(audioCtx.state==="suspended")audioCtx.resume();
  isRunning=true;
  elements.startBtn.classList.add("active");
  elements.startBtn.textContent="â¸ Running";
});

elements.profile.addEventListener("change",(e)=>{
  profile=e.target.value;
  elements.profileName.textContent=profile.charAt(0).toUpperCase()+profile.slice(1);
});

elements.volume.addEventListener("input",(e)=>{
  const vol=Math.round(Number(e.target.value)*100);
  elements.volDisplay.textContent=vol+"%";
  if(masterGain)masterGain.gain.value=Number(e.target.value);
});

elements.scanBtn.addEventListener("click",()=>scanGamepads(true));

function playSound(kind=profile,velocity=1){
  if(!audioCtx)return;
  const now=audioCtx.currentTime;
  const config=soundLibrary[kind]||soundLibrary.mechanical;
  const noise=audioCtx.createBufferSource();
  const bufLen=Math.floor(audioCtx.sampleRate*config.dur);
  const buffer=audioCtx.createBuffer(1,bufLen,audioCtx.sampleRate);
  const data=buffer.getChannelData(0);
  for(let i=0;i<bufLen;i++){
    data[i]=(Math.random()*2-1)*Math.exp(-i/bufLen*7)*velocity*0.9;
  }
  noise.buffer=buffer;
  const filter=audioCtx.createBiquadFilter();
  filter.type="bandpass";
  filter.frequency.value=config.freq;
  filter.Q.value=config.q;
  const gain=audioCtx.createGain();
  gain.gain.value=0.75;
  noise.connect(filter);
  filter.connect(gain);
  gain.connect(masterGain);
  noise.start(now);
  noise.stop(now+config.dur);
}

window.addEventListener("keydown",(e)=>{
  if(!isRunning||["Shift","Control","Alt","Meta"].includes(e.key))return;
  addRecentKey(e.key);
  playSound(profile,1.0);
});

function addRecentKey(k){
  const chip=document.createElement("div");
  chip.className="key-chip";
  chip.textContent=k.length>1?k.substring(0,8):k;
  elements.recentKeys.prepend(chip);
  while(elements.recentKeys.children.length>10)elements.recentKeys.removeChild(elements.recentKeys.lastChild);
}

function addRecentButton(s){
  const chip=document.createElement("div");
  chip.className="key-chip";
  chip.textContent=s;
  elements.recentButtons.prepend(chip);
  while(elements.recentButtons.children.length>10)elements.recentButtons.removeChild(elements.recentButtons.lastChild);
}

function addRecentAnalog(s){
  const chip=document.createElement("div");
  chip.className="key-chip";
  chip.textContent=s;
  elements.recentAnalog.prepend(chip);
  while(elements.recentAnalog.children.length>10)elements.recentAnalog.removeChild(elements.recentAnalog.lastChild);
}

function detectControllerType(gamepad){
  const id=gamepad.id.toLowerCase();
  if(id.includes("054c"))return"PS4";
  if(id.includes("ps5")||id.includes("dualsense"))return"PS5";
  if(id.includes("xbox")||id.includes("054c:09cc"))return"Xbox";
  if(id.includes("054c"))return"PS4";
  return"Generic";
}

function renderController(type){
  let svg="";
  if(type==="PS4"||type==="Generic"){
    svg=`<svg viewBox="0 0 300 180" width="380" height="228">
      <defs>
        <linearGradient id="psGrad" x1="0%" y1="0%" x2="0%" y2="100%">
          <stop offset="0%" style="stop-color:#1a1a2e;stop-opacity:1" />
          <stop offset="100%" style="stop-color:#0f0f1e;stop-opacity:1" />
        </linearGradient>
      </defs>
      <rect width="300" height="180" rx="30" fill="url(#psGrad)" stroke="rgba(168,85,247,0.4)" stroke-width="2"/>
      <circle cx="60" cy="80" r="18" class="stick" id="lstick" fill="rgba(168,85,247,0.3)" stroke="rgba(168,85,247,0.6)" stroke-width="2"/>
      <circle cx="240" cy="110" r="18" class="stick" id="rstick" fill="rgba(168,85,247,0.3)" stroke="rgba(168,85,247,0.6)" stroke-width="2"/>
      <circle cx="140" cy="60" r="16" class="btn" id="btn0" fill="rgba(100,200,255,0.2)" stroke="rgba(100,200,255,0.6)" stroke-width="2"/>
      <circle cx="170" cy="45" r="16" class="btn" id="btn1" fill="rgba(255,100,150,0.2)" stroke="rgba(255,100,150,0.6)" stroke-width="2"/>
      <circle cx="200" cy="60" r="16" class="btn" id="btn2" fill="rgba(100,100,255,0.2)" stroke="rgba(100,100,255,0.6)" stroke-width="2"/>
      <circle cx="170" cy="75" r="16" class="btn" id="btn3" fill="rgba(100,255,150,0.2)" stroke="rgba(100,255,150,0.6)" stroke-width="2"/>
      <text x="140" y="65" font-size="14" fill="rgba(168,85,247,0.8)" text-anchor="middle" dy=".3em">âœ•</text>
      <text x="170" y="50" font-size="14" fill="rgba(168,85,247,0.8)" text-anchor="middle" dy=".3em">â–³</text>
      <text x="205" y="65" font-size="14" fill="rgba(168,85,247,0.8)" text-anchor="middle" dy=".3em">â—¯</text>
      <text x="170" y="80" font-size="14" fill="rgba(168,85,247,0.8)" text-anchor="middle" dy=".3em">â–¢</text>
      <rect x="110" y="140" width="80" height="12" rx="6" fill="rgba(168,85,247,0.15)" stroke="rgba(168,85,247,0.3)" stroke-width="1"/>
      <rect x="120" y="145" width="10" height="6" rx="3" id="dpad-l" class="dpad" fill="rgba(168,85,247,0.2)"/>
      <rect x="138" y="145" width="10" height="6" rx="3" id="dpad-r" class="dpad" fill="rgba(168,85,247,0.2)"/>
      <rect x="129" y="136" width="6" height="10" rx="3" id="dpad-u" class="dpad" fill="rgba(168,85,247,0.2)"/>
      <rect x="129" y="154" width="6" height="10" rx="3" id="dpad-d" class="dpad" fill="rgba(168,85,247,0.2)"/>
      <circle cx="80" cy="155" r="8" class="btn" id="btn8" fill="rgba(168,85,247,0.15)" stroke="rgba(168,85,247,0.4)" stroke-width="1"/>
      <circle cx="220" cy="155" r="8" class="btn" id="btn9" fill="rgba(168,85,247,0.15)" stroke="rgba(168,85,247,0.4)" stroke-width="1"/>
      <circle cx="50" cy="20" r="6" class="btn" id="btn4" fill="rgba(168,85,247,0.15)" stroke="rgba(168,85,247,0.4)" stroke-width="1"/>
      <circle cx="250" cy="20" r="6" class="btn" id="btn5" fill="rgba(168,85,247,0.15)" stroke="rgba(168,85,247,0.4)" stroke-width="1"/>
    </svg>`;
  }else if(type==="PS5"){
    svg=`<svg viewBox="0 0 300 180" width="380" height="228">
      <defs>
        <linearGradient id="ps5Grad" x1="0%" y1="0%" x2="0%" y2="100%">
          <stop offset="0%" style="stop-color:#2a2a3e;stop-opacity:1" />
          <stop offset="100%" style="stop-color:#1a1a2e;stop-opacity:1" />
        </linearGradient>
      </defs>
      <rect width="300" height="180" rx="35" fill="url(#ps5Grad)" stroke="rgba(168,85,247,0.5)" stroke-width="2.5"/>
      <circle cx="60" cy="80" r="20" class="stick" id="lstick" fill="rgba(168,85,247,0.3)" stroke="rgba(168,85,247,0.7)" stroke-width="2.5"/>
      <circle cx="240" cy="110" r="20" class="stick" id="rstick" fill="rgba(168,85,247,0.3)" stroke="rgba(168,85,247,0.7)" stroke-width="2.5"/>
      <circle cx="140" cy="55" r="18" class="btn" id="btn0" fill="rgba(100,200,255,0.25)" stroke="rgba(100,200,255,0.7)" stroke-width="2.5"/>
      <circle cx="175" cy="40" r="18" class="btn" id="btn1" fill="rgba(255,100,150,0.25)" stroke="rgba(255,100,150,0.7)" stroke-width="2.5"/>
      <circle cx="210" cy="55" r="18" class="btn" id="btn2" fill="rgba(100,100,255,0.25)" stroke="rgba(100,100,255,0.7)" stroke-width="2.5"/>
      <circle cx="175" cy="70" r="18" class="btn" id="btn3" fill="rgba(100,255,150,0.25)" stroke="rgba(100,255,150,0.7)" stroke-width="2.5"/>
      <text x="140" y="61" font-size="16" fill="rgba(168,85,247,0.9)" text-anchor="middle" dy=".3em">âœ•</text>
      <text x="175" y="46" font-size="16" fill="rgba(168,85,247,0.9)" text-anchor="middle" dy=".3em">â–³</text>
      <text x="215" y="61" font-size="16" fill="rgba(168,85,247,0.9)" text-anchor="middle" dy=".3em">â—¯</text>
      <text x="175" y="76" font-size="16" fill="rgba(168,85,247,0.9)" text-anchor="middle" dy=".3em">â–¢</text>
      <rect x="100" y="145" width="100" height="14" rx="7" fill="rgba(168,85,247,0.2)" stroke="rgba(168,85,247,0.4)" stroke-width="1.5"/>
      <rect x="108" y="150" width="12" height="8" rx="4" id="dpad-l" class="dpad" fill="rgba(168,85,247,0.2)"/>
      <rect x="180" y="150" width="12" height="8" rx="4" id="dpad-r" class="dpad" fill="rgba(168,85,247,0.2)"/>
      <rect x="144" y="139" width="8" height="12" rx="4" id="dpad-u" class="dpad" fill="rgba(168,85,247,0.2)"/>
      <rect x="144" y="161" width="8" height="12" rx="4" id="dpad-d" class="dpad" fill="rgba(168,85,247,0.2)"/>
      <circle cx="75" cy="160" r="9" class="btn" id="btn8" fill="rgba(168,85,247,0.15)" stroke="rgba(168,85,247,0.5)" stroke-width="1.5"/>
      <circle cx="225" cy="160" r="9" class="btn" id="btn9" fill="rgba(168,85,247,0.15)" stroke="rgba(168,85,247,0.5)" stroke-width="1.5"/>
      <circle cx="45" cy="15" r="7" class="btn" id="btn4" fill="rgba(168,85,247,0.15)" stroke="rgba(168,85,247,0.5)" stroke-width="1.5"/>
      <circle cx="255" cy="15" r="7" class="btn" id="btn5" fill="rgba(168,85,247,0.15)" stroke="rgba(168,85,247,0.5)" stroke-width="1.5"/>
    </svg>`;
  }else{
    svg=`<svg viewBox="0 0 300 180" width="380" height="228">
      <defs>
        <linearGradient id="xboxGrad" x1="0%" y1="0%" x2="0%" y2="100%">
          <stop offset="0%" style="stop-color:#1a1a2e;stop-opacity:1" />
          <stop offset="100%" style="stop-color:#0f0f1e;stop-opacity:1" />
        </linearGradient>
      </defs>
      <rect width="300" height="180" rx="25" fill="url(#xboxGrad)" stroke="rgba(168,85,247,0.4)" stroke-width="2"/>
      <circle cx="70" cy="90" r="18" class="stick" id="lstick" fill="rgba(168,85,247,0.3)" stroke="rgba(168,85,247,0.6)" stroke-width="2"/>
      <circle cx="230" cy="90" r="18" class="stick" id="rstick" fill="rgba(168,85,247,0.3)" stroke="rgba(168,85,247,0.6)" stroke-width="2"/>
      <circle cx="150" cy="50" r="15" class="btn" id="btn2" fill="rgba(255,200,50,0.2)" stroke="rgba(255,200,50,0.6)" stroke-width="2"/>
      <circle cx="175" cy="65" r="15" class="btn" id="btn1" fill="rgba(50,150,255,0.2)" stroke="rgba(50,150,255,0.6)" stroke-width="2"/>
      <circle cx="125" cy="65" r="15" class="btn" id="btn3" fill="rgba(100,50,200,0.2)" stroke="rgba(100,50,200,0.6)" stroke-width="2"/>
      <circle cx="150" cy="80" r="15" class="btn" id="btn0" fill="rgba(50,200,100,0.2)" stroke="rgba(50,200,100,0.6)" stroke-width="2"/>
      <text x="150" y="55" font-size="12" fill="rgba(255,200,50,0.8)" text-anchor="middle" dy=".3em">Y</text>
      <text x="180" y="70" font-size="12" fill="rgba(50,150,255,0.8)" text-anchor="middle" dy=".3em">A</text>
      <text x="120" y="70" font-size="12" fill="rgba(100,50,200,0.8)" text-anchor="middle" dy=".3em">X</text>
      <text x="150" y="85" font-size="12" fill="rgba(50,200,100,0.8)" text-anchor="middle" dy=".3em">B</text>
      <rect x="100" y="140" width="100" height="14" rx="7" fill="rgba(168,85,247,0.15)" stroke="rgba(168,85,247,0.3)" stroke-width="1"/>
      <circle cx="85" cy="155" r="8" class="btn" id="btn8" fill="rgba(168,85,247,0.15)" stroke="rgba(168,85,247,0.4)" stroke-width="1"/>
      <circle cx="215" cy="155" r="8" class="btn" id="btn9" fill="rgba(168,85,247,0.15)" stroke="rgba(168,85,247,0.4)" stroke-width="1"/>
    </svg>`;
  }
  elements.controllerViz.innerHTML=svg;
}

function scanGamepads(force=false){
  const gps=navigator.getGamepads?navigator.getGamepads():[];
  let found=false;
  for(let i=0;i<gps.length;i++){
    const g=gps[i];
    if(g&&g.connected){
      found=true;
      connectedGpIndex=i;
      prevButtonStates=new Array(g.buttons.length).fill(false);
      prevAxes=new Array(g.axes.length).fill(0);
      const type=detectControllerType(g);
      elements.gpIndicator.classList.add("connected");
      elements.gpName.textContent=type+" Connected";
      elements.gpInfo.textContent=g.id.substring(0,40);
      renderController(type);
      break;
    }
  }
  if(!found){
    elements.gpIndicator.classList.remove("connected");
    elements.gpName.textContent="No Controller";
    elements.gpInfo.textContent="";
    renderController("PS4");
    connectedGpIndex=null;
  }
}

function pollGamepad(){
  const gps=navigator.getGamepads?navigator.getGamepads():[];
  const g=connectedGpIndex!==null?gps[connectedGpIndex]:null;
  if(!g){
    for(let i=0;i<gps.length;i++){
      if(gps[i]&&gps[i].connected){
        connectedGpIndex=i;
        scanGamepads(true);
        break;
      }
    }
    requestAnimationFrame(pollGamepad);
    return;
  }
  const buttons=g.buttons;
  for(let i=0;i<buttons.length;i++){
    const pressed=buttons[i].pressed||buttons[i].value>0.1;
    const prev=prevButtonStates[i]||false;
    if(pressed&&(!prev||elements.autoRepeat.checked)){
      handleButtonPress(i,buttons[i].value);
    }
    prevButtonStates[i]=pressed;
    const dot=document.querySelector('.btn[id="btn'+i+'"]');
    if(dot)dot.style.filter=pressed?"brightness(2) drop-shadow(0 0 10px rgba(168,85,247,0.8))":"brightness(1)";
  }
  const axes=g.axes;
  if(axes.length>=4){
    const lx=Math.abs(axes[0])>STICK_DEADZONE?axes[0]:0;
    const ly=Math.abs(axes[1])>STICK_DEADZONE?axes[1]:0;
    const rx=Math.abs(axes[2])>STICK_DEADZONE?axes[2]:0;
    const ry=Math.abs(axes[3])>STICK_DEADZONE?axes[3]:0;
    elements.lStick.textContent=`x:${lx.toFixed(2)} y:${ly.toFixed(2)}`;
    elements.rStick.textContent=`x:${rx.toFixed(2)} y:${ry.toFixed(2)}`;
    const lstick=document.getElementById("lstick");
    const rstick=document.getElementById("rstick");
    if(lstick){
      lstick.style.transform=`translate(${lx*12}px,${ly*12}px)`;
      lstick.style.filter=Math.abs(lx)>STICK_MOVE_THRESHOLD||Math.abs(ly)>STICK_MOVE_THRESHOLD?"brightness(2) drop-shadow(0 0 12px rgba(100,200,255,0.8))":"brightness(1)";
    }
    if(rstick){
      rstick.style.transform=`translate(${rx*12}px,${ry*12}px)`;
      rstick.style.filter=Math.abs(rx)>STICK_MOVE_THRESHOLD||Math.abs(ry)>STICK_MOVE_THRESHOLD?"brightness(2) drop-shadow(0 0 12px rgba(100,200,255,0.8))":"brightness(1)";
    }
    if((Math.abs(lx)>STICK_MOVE_THRESHOLD||Math.abs(ly)>STICK_MOVE_THRESHOLD)&&isRunning){
      const now=performance.now();
      if(!lastStickMovements.l||now-lastStickMovements.l>150){
        lastStickMovements.l=now;
        addRecentAnalog("LS");
        playSound(profile,0.6);
      }
    }
    if((Math.abs(rx)>STICK_MOVE_THRESHOLD||Math.abs(ry)>STICK_MOVE_THRESHOLD)&&isRunning){
      const now=performance.now();
      if(!lastStickMovements.r||now-lastStickMovements.r>150){
        lastStickMovements.r=now;
        addRecentAnalog("RS");
        playSound(profile,0.6);
      }
    }
  }
  const l2=buttons[6]?buttons[6].value:0;
  const r2=buttons[7]?buttons[7].value:0;
  elements.triggers.textContent=`L:${l2.toFixed(2)} R:${r2.toFixed(2)}`;
  if((l2>0.1||r2>0.1)&&isRunning){
    const now=performance.now();
    if(!lastStickMovements.t||now-lastStickMovements.t>200){
      lastStickMovements.t=now;
      addRecentAnalog(l2>r2?"L2":"R2");
      playSound(profile,0.7);
    }
  }
  requestAnimationFrame(pollGamepad);
}

function handleButtonPress(index,value){
  const now=performance.now();
  const key="b"+index;
  if(lastPressTimes[key]&&(now-lastPressTimes[key]<MIN_INTERVAL))return;
  lastPressTimes[key]=now;
  if(!isRunning)return;
  const readable=["âœ•","â—¯","â–¢","â–³","L1","R1","L2","R2","Share","Opt","L3","R3","â†‘","â†“","â†","â†’","PS","Touch"][index]||"Btn";
  addRecentButton(readable);
  const velocity=Math.min(1,Math.max(0.2,value||1));
  playSound(profile,velocity);
}

window.addEventListener("gamepadconnected",()=>scanGamepads(true));
window.addEventListener("gamepaddisconnected",()=>scanGamepads(true));
document.body.addEventListener("pointerdown",()=>{initAudio();if(audioCtx&&audioCtx.state==="suspended")audioCtx.resume()},{once:true});

scanGamepads();
pollGamepad();
</script>
</body>
</html>
